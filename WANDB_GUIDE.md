# Wandb é›†æˆä½¿ç”¨æŒ‡å—

æœ¬é¡¹ç›®å·²é›†æˆ [Weights & Biases (wandb)](https://wandb.ai/) ç”¨äºè®­ç»ƒè¿‡ç¨‹çš„å¯è§†åŒ–å’Œè·Ÿè¸ªã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. è®­ç»ƒæŒ‡æ ‡è®°å½•
- **Loss**: æ¯ `log_every_step` æ­¥è®°å½•ä¸€æ¬¡è®­ç»ƒæŸå¤±
- **Epoch**: å½“å‰è®­ç»ƒè½®æ¬¡
- **Step**: å…¨å±€è®­ç»ƒæ­¥æ•°

### 2. è¯„ä¼°æŒ‡æ ‡è®°å½•
- **MSE**: å‡æ–¹è¯¯å·® (Mean Squared Error)
- **PSNR**: å³°å€¼ä¿¡å™ªæ¯” (Peak Signal-to-Noise Ratio)

### 3. å›¾åƒå¯è§†åŒ–

#### è®­ç»ƒè¿‡ç¨‹å¯è§†åŒ– (`train/visualization`)
- æ¯ `visualize_every_step` æ­¥ç”Ÿæˆä¸€æ¬¡
- æ˜¾ç¤ºæ ¼å¼ï¼š
  ```
  [Past Frame 1] [Past Frame 2] [Past Frame 3] [Past Frame 4] | [GT 1] [Pred 1] | [GT 2] [Pred 2] | [GT 3] [Pred 3] | [GT 4] [Pred 4]
  ```
- ä½¿ç”¨ EMA æ¨¡å‹ç”Ÿæˆé¢„æµ‹
- å¯¹æ¯”åŸå§‹è¾“å…¥å¸§ã€Ground Truth å’Œæ¨¡å‹é¢„æµ‹

#### è¯„ä¼°ç»“æœå¯è§†åŒ– (`eval/predictions`)
- æ¯æ¬¡è¯„ä¼°æ—¶ç”Ÿæˆå‰ 10 ä¸ªæ ·æœ¬çš„å¯è§†åŒ–
- æ˜¾ç¤ºæ ¼å¼ï¼š
  ```
  [Past Frames] | [Ground Truth Future Frames] | [Predicted Future Frames]
  ```

## å®‰è£…å’Œé…ç½®

### 1. å®‰è£… wandb

```bash
conda activate diff
pip install wandb
```

### 2. ç™»å½• wandb

é¦–æ¬¡ä½¿ç”¨éœ€è¦ç™»å½•ï¼š

```bash
wandb login
```

ç³»ç»Ÿä¼šæç¤ºä½ è¾“å…¥ API keyï¼Œä½ å¯ä»¥åœ¨ [wandb.ai/authorize](https://wandb.ai/authorize) è·å–ã€‚

### 3. é…ç½®æ–‡ä»¶è®¾ç½®

åœ¨ `configs/config_video_prediction.yaml` ä¸­é…ç½®ï¼š

```yaml
Global:
  # Wandb configuration
  use_wandb: true  # å¯ç”¨/ç¦ç”¨ wandb
  wandb_project: 'diffad-video-prediction'  # é¡¹ç›®åç§°
  wandb_run_name: null  # è¿è¡Œåç§°ï¼ˆnull ä¸ºè‡ªåŠ¨ç”Ÿæˆï¼‰

Train:
  log_every_step: 100  # æ¯ 100 æ­¥è®°å½•ä¸€æ¬¡æŒ‡æ ‡
  visualize_every_step: 1000  # æ¯ 1000 æ­¥å¯è§†åŒ–ä¸€æ¬¡
  eval_every_epoch: 5  # æ¯ 5 ä¸ª epoch è¯„ä¼°ä¸€æ¬¡
```

## ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨è®­ç»ƒ

```bash
# å• GPU
CUDA_VISIBLE_DEVICES=0 python train_video_pred.py --config configs/config_video_prediction.yaml

# å¤š GPU (DDP)
CUDA_VISIBLE_DEVICES=0,1,2,3 torchrun --nproc_per_node=4 train_video_pred.py --config configs/config_video_prediction.yaml
```

### æŸ¥çœ‹ç»“æœ

è®­ç»ƒå¼€å§‹åï¼Œwandb ä¼šè‡ªåŠ¨åœ¨ç»ˆç«¯è¾“å‡ºä¸€ä¸ªé“¾æ¥ï¼Œç‚¹å‡»å³å¯åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹å®æ—¶è®­ç»ƒè¿›åº¦ã€‚

ä¾‹å¦‚ï¼š
```
wandb: ğŸš€ View run at https://wandb.ai/your-username/diffad-video-prediction/runs/xxxxx
```

## Wandb ä»ªè¡¨æ¿è¯´æ˜

### Overview æ ‡ç­¾é¡µ
- æ˜¾ç¤ºæ‰€æœ‰è®°å½•çš„æŒ‡æ ‡æ›²çº¿
- å¯ä»¥å¯¹æ¯”ä¸åŒè¿è¡Œçš„ç»“æœ

### Charts æ ‡ç­¾é¡µ
è‡ªåŠ¨ç”Ÿæˆçš„å›¾è¡¨åŒ…æ‹¬ï¼š
- `train/loss`: è®­ç»ƒæŸå¤±æ›²çº¿
- `train/epoch`: è®­ç»ƒè¿›åº¦
- `eval/mse`: è¯„ä¼° MSE æ›²çº¿
- `eval/psnr`: è¯„ä¼° PSNR æ›²çº¿

### Media æ ‡ç­¾é¡µ
å›¾åƒå¯è§†åŒ–ï¼š
- `train/visualization`: è®­ç»ƒè¿‡ç¨‹ä¸­çš„é¢„æµ‹å¯¹æ¯”
- `eval/predictions`: è¯„ä¼°æ—¶çš„é¢„æµ‹å¯¹æ¯”

### System æ ‡ç­¾é¡µ
- GPU ä½¿ç”¨ç‡
- å†…å­˜å ç”¨
- CPU ä½¿ç”¨ç‡

## ç¦ç”¨ wandb

å¦‚æœä¸æƒ³ä½¿ç”¨ wandbï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼š

```yaml
Global:
  use_wandb: false
```

æˆ–è€…ç›´æ¥å¸è½½ wandbï¼š

```bash
pip uninstall wandb
```

ç¨‹åºä¼šè‡ªåŠ¨æ£€æµ‹å¹¶åœ¨æ²¡æœ‰ wandb çš„æƒ…å†µä¸‹æ­£å¸¸è¿è¡Œã€‚

## é«˜çº§åŠŸèƒ½

### è‡ªå®šä¹‰è¿è¡Œåç§°

```yaml
Global:
  wandb_run_name: 'my-experiment-v1'
```

### æ¢å¤è®­ç»ƒ

wandb æ”¯æŒè‡ªåŠ¨æ¢å¤ä¸­æ–­çš„è®­ç»ƒï¼š

```yaml
Global:
  load_from: 'checkpoints/video_prediction/step_10000.pt'
  use_wandb: true
```

wandb ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶ç»§ç»­ä¹‹å‰çš„è¿è¡Œã€‚

### å›¢é˜Ÿåä½œ

1. åœ¨ wandb.ai åˆ›å»ºå›¢é˜Ÿ
2. ä¿®æ”¹é¡¹ç›®åç§°ä¸º `team-name/project-name`ï¼š

```yaml
Global:
  wandb_project: 'my-team/diffad-video-prediction'
```

## å¯è§†åŒ–ç¤ºä¾‹

### è®­ç»ƒè¿‡ç¨‹å¯è§†åŒ–å¸ƒå±€

è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¯è§†åŒ–å›¾åƒæŒ‰ä»¥ä¸‹å¸ƒå±€ç»„ç»‡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Past Input Frames (Context)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frame 1 â”‚ Frame 2 â”‚ Frame 3 â”‚ Frame 4 â”‚ GT/Pred â”‚ GT/Pred â”‚ GT/Pred â”‚
â”‚ (t=-3)  â”‚ (t=-2)  â”‚ (t=-1)  â”‚ (t=0)   â”‚ (t=1)   â”‚ (t=2)   â”‚ (t=3)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ¯å¯¹ GT/Pred åŒ…å«ä¸Šä¸‹ä¸¤å¼ å›¾ç‰‡ï¼š
- ä¸Šæ–¹ï¼šGround Truthï¼ˆçœŸå®æœªæ¥å¸§ï¼‰
- ä¸‹æ–¹ï¼šPredictedï¼ˆæ¨¡å‹é¢„æµ‹ï¼‰

### è¯„ä¼°ç»“æœå¯è§†åŒ–å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Past Frames         â”‚   Ground Truth        â”‚   Predictions         â”‚
â”‚   (4 frames)          â”‚   (4 future frames)   â”‚   (4 future frames)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•…éšœæ’é™¤

### 1. wandb ç™»å½•å¤±è´¥

```bash
# æ‰‹åŠ¨è®¾ç½® API key
export WANDB_API_KEY=your_api_key_here
```

### 2. ç¦»çº¿æ¨¡å¼

å¦‚æœç½‘ç»œä¸ç¨³å®šï¼Œå¯ä»¥ä½¿ç”¨ç¦»çº¿æ¨¡å¼ï¼š

```bash
export WANDB_MODE=offline
```

è®­ç»ƒç»“æŸåå¯ä»¥æ‰‹åŠ¨åŒæ­¥ï¼š

```bash
wandb sync wandb/offline-run-xxxxx
```

### 3. DDP å¤šè¿›ç¨‹é—®é¢˜

wandb å·²é…ç½®ä¸ºåªåœ¨ rank 0 è¿›ç¨‹è®°å½•ï¼Œé¿å…é‡å¤ã€‚å¦‚æœé‡åˆ°é—®é¢˜ï¼Œæ£€æŸ¥ï¼š

```python
# åœ¨ä»£ç ä¸­
if self.rank == 0 and self.use_wandb:
    wandb.log(...)
```

## æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½®è®°å½•é¢‘ç‡**ï¼š
   - `log_every_step`: å»ºè®® 50-100
   - `visualize_every_step`: å»ºè®® 500-1000ï¼ˆå¯è§†åŒ–è¾ƒè€—æ—¶ï¼‰

2. **è¯„ä¼°é¢‘ç‡**ï¼š
   - æ ¹æ®æ•°æ®é›†å¤§å°è°ƒæ•´ `eval_every_epoch`
   - å¤§æ•°æ®é›†å¯ä»¥è®¾ç½®ä¸º 5-10 ä¸ª epoch ä¸€æ¬¡

3. **ç£ç›˜ç©ºé—´**ï¼š
   - wandb ä¼šåœ¨æœ¬åœ°ç¼“å­˜æ•°æ®ï¼ˆé»˜è®¤åœ¨ `wandb/` ç›®å½•ï¼‰
   - å®šæœŸæ¸…ç†æ—§çš„è¿è¡Œè®°å½•

4. **ç½‘ç»œå¸¦å®½**ï¼š
   - å›¾åƒä¸Šä¼ è¾ƒè€—å¸¦å®½
   - å¯ä»¥é€‚å½“é™ä½ `visualize_every_step` çš„é¢‘ç‡

## ç›¸å…³èµ„æº

- [Wandb å®˜æ–¹æ–‡æ¡£](https://docs.wandb.ai/)
- [Wandb PyTorch é›†æˆæŒ‡å—](https://docs.wandb.ai/guides/integrations/pytorch)
- [Wandb å›¾åƒå¯è§†åŒ–](https://docs.wandb.ai/guides/track/log/media)

