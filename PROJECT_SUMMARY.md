# ðŸ“Š é¡¹ç›®æ€»ç»“ï¼šFront Cameraè§†é¢‘é¢„æµ‹è®­ç»ƒç³»ç»Ÿ

## ðŸŽ¯ é¡¹ç›®ç›®æ ‡

ä¸ºBench2Driveæ•°æ®é›†åˆ›å»ºä¸€å¥—å®Œæ•´çš„**å‰ç½®æ‘„åƒå¤´æœªæ¥å¸§é¢„æµ‹**è®­ç»ƒç³»ç»Ÿã€‚

**ä»»åŠ¡**: è¾“å…¥4å¸§åŽ†å²å›¾åƒ â†’ é¢„æµ‹æœªæ¥4å¸§å›¾åƒ

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒä»£ç å®žçŽ° âœ“

#### æ•°æ®é›†æ¨¡å—
- âœ… **FrontCameraVideoDataset** (`dataset/video_prediction_dataset.py`)
  - åŠ è½½Bench2Driveå¤šè§†è§’å›¾åƒï¼ˆä»…ä½¿ç”¨frontç›¸æœºï¼‰
  - æž„å»ºæ—¶åºæ ·æœ¬ï¼špast_frames + future_frames
  - æ•°æ®å¢žå¼ºå’Œå½’ä¸€åŒ–
  - æ™ºèƒ½è¿‡æ»¤æœ‰æ•ˆæ—¶åºç‰‡æ®µ
  - æ”¯æŒè®­ç»ƒ/éªŒè¯æ¨¡å¼åˆ‡æ¢

#### æ¨¡åž‹æ¨¡å—  
- âœ… **VideoPredictionDiffusion** (`model/video_prediction_diffusion.py`)
  - **TemporalEncoder**: 3Då·ç§¯ + æ—¶åºæ³¨æ„åŠ›ç¼–ç åŽ†å²ä¿¡æ¯
  - **VideoDiT**: åŸºäºŽDiTçš„æ‰©æ•£æ¨¡åž‹ï¼Œèžåˆæ—¶åºæ¡ä»¶
  - **VAE**: ä½¿ç”¨é¢„è®­ç»ƒçš„Stable Diffusion VAEè¿›è¡Œå›¾åƒç¼–ç /è§£ç 
  - **DDIMé‡‡æ ·**: é«˜æ•ˆçš„åŽ»å™ªç”Ÿæˆè¿‡ç¨‹
  - å®Œæ•´çš„å‰å‘ä¼ æ’­å’Œé‡‡æ ·å‡½æ•°

#### è®­ç»ƒæ¨¡å—
- âœ… **VideoPredictionTrainer** (`video_prediction_trainer.py`)
  - åˆ†å¸ƒå¼è®­ç»ƒæ”¯æŒ (PyTorch DDP)
  - EMA (æŒ‡æ•°ç§»åŠ¨å¹³å‡) æ¨¡åž‹ç»´æŠ¤
  - æ¢¯åº¦è£å‰ªå’Œä¼˜åŒ–
  - TensorBoardæ—¥å¿—è®°å½•
  - è‡ªåŠ¨ä¿å­˜/åŠ è½½æ£€æŸ¥ç‚¹
  - å®šæœŸè¯„ä¼°å’Œå¯è§†åŒ–
  - å®Œæ•´çš„è®­ç»ƒå¾ªçŽ¯å’Œè¯„ä¼°å¾ªçŽ¯

### 2. å·¥å…·è„šæœ¬ âœ“

- âœ… **train_video_pred.py**: è®­ç»ƒå…¥å£è„šæœ¬
  - æ”¯æŒå•GPUå’Œå¤šGPUè®­ç»ƒ
  - æ”¯æŒä»Žæ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ
  - å‘½ä»¤è¡Œå‚æ•°é…ç½®

- âœ… **eval_video_pred.py**: è¯„ä¼°è„šæœ¬
  - è®¡ç®—MSEã€PSNRã€MAEç­‰æŒ‡æ ‡
  - ç”Ÿæˆå¯è§†åŒ–å¯¹æ¯”å›¾
  - æ‰¹é‡è¯„ä¼°å’Œç»Ÿè®¡

- âœ… **inference_demo.py**: æŽ¨ç†æ¼”ç¤ºè„šæœ¬
  - ä»Žä»»æ„4å¼ å›¾åƒé¢„æµ‹æœªæ¥
  - çµæ´»çš„é‡‡æ ·æ­¥æ•°æŽ§åˆ¶
  - å¯è§†åŒ–è¾“å‡º

- âœ… **prepare_video_data.py**: æ•°æ®é¢„å¤„ç†è„šæœ¬
  - è‡ªåŠ¨æ‰«ææ•°æ®ç›®å½•
  - ç”Ÿæˆè®­ç»ƒ/éªŒè¯é›†åˆ’åˆ†
  - åˆ›å»ºpklæ ¼å¼æ ‡æ³¨æ–‡ä»¶
  - æ•°æ®å®Œæ•´æ€§éªŒè¯

- âœ… **test_video_prediction.py**: ç³»ç»Ÿæµ‹è¯•è„šæœ¬
  - ä¾èµ–æ£€æŸ¥
  - æ¨¡å—å¯¼å…¥æµ‹è¯•
  - å‰å‘ä¼ æ’­éªŒè¯
  - é…ç½®æ–‡ä»¶æ£€æŸ¥

- âœ… **quick_start.sh**: ä¸€é”®å¯åŠ¨è„šæœ¬
  - äº¤äº’å¼å®‰è£…å’Œé…ç½®
  - è‡ªåŠ¨æ£€æµ‹çŽ¯å¢ƒ
  - å¤šGPUè®­ç»ƒé€‰é¡¹

### 3. é…ç½®æ–‡ä»¶ âœ“

- âœ… **config_video_prediction.yaml**
  - å®Œæ•´çš„è®­ç»ƒé…ç½®
  - æ¨¡åž‹è¶…å‚æ•°
  - æ•°æ®é›†é…ç½®
  - è®­ç»ƒç­–ç•¥è®¾ç½®

- âœ… **requirements_video_pred.txt**
  - æ‰€æœ‰å¿…éœ€ä¾èµ–åŒ…
  - ç‰ˆæœ¬è¦æ±‚è¯´æ˜Ž

### 4. æ–‡æ¡£ âœ“

- âœ… **VIDEO_PREDICTION_README.md** - å®Œæ•´ä½¿ç”¨æ–‡æ¡£
  - é¡¹ç›®æ¦‚è¿°
  - è¯¦ç»†å®‰è£…æŒ‡å—
  - é…ç½®å‚æ•°è¯´æ˜Ž
  - è®­ç»ƒè¯„ä¼°æµç¨‹
  - å¸¸è§é—®é¢˜è§£ç­”
  - é«˜çº§ç”¨æ³•å’Œä¼˜åŒ–å»ºè®®

- âœ… **VIDEO_PREDICTION_FILES.md** - æ–‡ä»¶æ¸…å•
  - æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨å’Œè¯´æ˜Ž
  - ç›®å½•ç»“æž„
  - ä½¿ç”¨æµç¨‹
  - ä¿®æ”¹æŒ‡å—

- âœ… **QUICK_START_GUIDE.md** - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
  - 10åˆ†é’Ÿå¿«é€Ÿå¼€å§‹
  - æœ€å°åŒ–æ­¥éª¤
  - å¸¸è§é—®é¢˜é€ŸæŸ¥

- âœ… **PROJECT_SUMMARY.md** - æœ¬æ–‡æ¡£
  - é¡¹ç›®æ€»è§ˆ
  - æŠ€æœ¯ç»†èŠ‚
  - ä½¿ç”¨ç¤ºä¾‹

---

## ðŸ—ï¸ ç³»ç»Ÿæž¶æž„

### æ•°æ®æµ
```
åŽŸå§‹å›¾åƒ (928Ã—1600)
    â†“ DataLoader
åŽ†å²å¸§ [B, 4, 3, 256, 448]
    â†“ VAE Encoder
åŽ†å²æ½œåœ¨ [B, 4, 4, 32, 56]
    â†“ TemporalEncoder
æ—¶åºç‰¹å¾ [B, 512, 32, 56] + æ—¶åºtoken [B, 4, D]
    â†“ 
éšæœºå™ªå£° [B, 4, 4, 32, 56]
    â†“ VideoDiT (è¿­ä»£åŽ»å™ª)
æœªæ¥æ½œåœ¨ [B, 4, 4, 32, 56]
    â†“ VAE Decoder
æœªæ¥å¸§ [B, 4, 3, 256, 448]
```

### è®­ç»ƒæµç¨‹
```
1. åŠ è½½batchæ•°æ®
   - past_frames: [B, 4, 3, H, W]
   - future_frames: [B, 4, 3, H, W]

2. VAEç¼–ç åˆ°æ½œåœ¨ç©ºé—´
   - past_latents: [B, 4, C, h, w]
   - future_latents: [B, 4, C, h, w]

3. æ—¶åºç¼–ç 
   - temporal_features, temporal_tokens = TemporalEncoder(past_latents)

4. æ‰©æ•£è®­ç»ƒ
   - é‡‡æ ·æ—¶é—´æ­¥ t ~ U(0, 1000)
   - æ·»åŠ å™ªå£°: x_t = âˆšÎ±_tÂ·x_0 + âˆš(1-Î±_t)Â·Îµ
   - é¢„æµ‹å™ªå£°: Îµ_pred = DiT(x_t, t, temporal_tokens)
   - è®¡ç®—æŸå¤±: L = MSE(Îµ_pred, Îµ)

5. ä¼˜åŒ–å’Œæ›´æ–°
   - åå‘ä¼ æ’­
   - æ¢¯åº¦è£å‰ª
   - ä¼˜åŒ–å™¨æ›´æ–°
   - EMAæ›´æ–°
```

### æŽ¨ç†æµç¨‹
```
1. åŠ è½½4å¸§åŽ†å²å›¾åƒ

2. VAEç¼–ç  + TemporalEncoder
   - æå–æ—¶åºç‰¹å¾

3. åˆå§‹åŒ–éšæœºå™ªå£°
   - z ~ N(0, I)

4. DDIMé‡‡æ · (50æ­¥)
   - é€æ­¥åŽ»å™ª
   - æ¯æ­¥ä½¿ç”¨æ—¶åºæ¡ä»¶

5. VAEè§£ç 
   - ç”Ÿæˆ4å¸§æœªæ¥å›¾åƒ

6. åŽå¤„ç†å’Œå¯è§†åŒ–
```

---

## ðŸ“Š æŠ€æœ¯è§„æ ¼

### æ¨¡åž‹è§„æ ¼
| ç»„ä»¶ | è§„æ ¼ |
|------|------|
| VAE | Stable Diffusion VAE (4é€šé“ï¼Œ8Ã—ä¸‹é‡‡æ ·) |
| TemporalEncoder | 4å±‚Conv3D + Multi-head Attention |
| DiT | DiT-L/2 (1152ç»´, 28å±‚, 16å¤´) |
| æ€»å‚æ•°é‡ | ~400M (å¯è®­ç»ƒçº¦350M) |

### è®­ç»ƒè§„æ ¼
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜Ž |
|------|--------|------|
| Batch Size | 4/GPU | å¯æ ¹æ®æ˜¾å­˜è°ƒæ•´ |
| Learning Rate | 1e-4 | AdamWä¼˜åŒ–å™¨ |
| Weight Decay | 1e-2 | æ­£åˆ™åŒ– |
| Gradient Clip | 1.0 | æ¢¯åº¦è£å‰ª |
| EMA Decay | 0.9999 | æŒ‡æ•°ç§»åŠ¨å¹³å‡ |
| Max Epochs | 100 | æ€»è®­ç»ƒè½®æ•° |

### æ•°æ®è§„æ ¼
| å‚æ•° | å€¼ | è¯´æ˜Ž |
|------|-----|------|
| è¾“å…¥å¸§æ•° | 4 | åŽ†å²å¸§ |
| è¾“å‡ºå¸§æ•° | 4 | æœªæ¥å¸§ |
| é‡‡æ ·é—´éš” | 5 | 0.5ç§’ |
| å›¾åƒå°ºå¯¸ | 256Ã—448 | ä¸‹é‡‡æ ·åŽ |
| æ½œåœ¨å°ºå¯¸ | 32Ã—56 | VAEç¼–ç åŽ |

---

## ðŸ’» ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºç¡€è®­ç»ƒ
```bash
# å‡†å¤‡æ•°æ®
python prepare_video_data.py \
    --data_root data/bench2drive \
    --output_dir data/infos

# å¯åŠ¨è®­ç»ƒï¼ˆ4 GPUï¼‰
torchrun --nproc_per_node=4 train_video_pred.py \
    --config configs/config_video_prediction.yaml
```

### ç¤ºä¾‹2: æ¢å¤è®­ç»ƒ
```bash
python train_video_pred.py \
    --config configs/config_video_prediction.yaml \
    --resume checkpoints/video_prediction/step_25000.pt
```

### ç¤ºä¾‹3: è¯„ä¼°æ¨¡åž‹
```bash
python eval_video_pred.py \
    --config configs/config_video_prediction.yaml \
    --ckpt checkpoints/video_prediction/step_50000.pt \
    --num_samples 100 \
    --save_visualizations
```

### ç¤ºä¾‹4: å•å›¾æŽ¨ç†
```bash
python inference_demo.py \
    --config configs/config_video_prediction.yaml \
    --ckpt checkpoints/video_prediction/final.pt \
    --images frame1.png frame2.png frame3.png frame4.png \
    --output prediction.png \
    --num_steps 100
```

---

## ðŸ“ˆ é¢„æœŸæ•ˆæžœ

### è®­ç»ƒæ›²çº¿
- **Loss**: åˆå§‹ ~0.1, æ”¶æ•›è‡³ ~0.01-0.02
- **æ”¶æ•›æ—¶é—´**: çº¦50Kæ­¥ (30-50å°æ—¶ï¼Œ4Ã—RTX3090)

### è¯„ä¼°æŒ‡æ ‡ (å‚è€ƒ)
| æŒ‡æ ‡ | æœŸæœ›å€¼ | è¯´æ˜Ž |
|------|--------|------|
| PSNR | >20 dB | å³°å€¼ä¿¡å™ªæ¯” |
| MSE | <0.01 | å‡æ–¹è¯¯å·® |
| MAE | <0.05 | å¹³å‡ç»å¯¹è¯¯å·® |

### ç”Ÿæˆè´¨é‡
- **æ—¶åºè¿žè´¯æ€§**: é¢„æµ‹å¸§ä¹‹é—´è¿åŠ¨å¹³æ»‘
- **ç»†èŠ‚ä¿æŒ**: ä¿æŒè½¦è¾†ã€é“è·¯ç­‰å…³é”®å…ƒç´ 
- **çœŸå®žåº¦**: ç¬¦åˆé©¾é©¶åœºæ™¯çš„ç‰©ç†è§„å¾‹

---

## ðŸ”§ å¯æ‰©å±•æ€§

### 1. ä¿®æ”¹é¢„æµ‹æ—¶é•¿
```yaml
# é…ç½®æ–‡ä»¶
Model:
  future_frames: 8  # é¢„æµ‹8å¸§ï¼ˆ0.8ç§’ï¼‰
```

### 2. æ·»åŠ æŽ§åˆ¶æ¡ä»¶
åœ¨æ¨¡åž‹ä¸­åŠ å…¥ï¼š
- æ–¹å‘ç›˜è§’åº¦
- è½¦é€Ÿ
- å¯¼èˆªæŒ‡ä»¤

### 3. å¤šè§†è§’æ‰©å±•
ä¿®æ”¹æ•°æ®é›†åŠ è½½æ‰€æœ‰ç›¸æœºï¼š
- front, front_left, front_right
- back, back_left, back_right

### 4. æ›´é«˜åˆ†è¾¨çŽ‡
```yaml
Model:
  img_size: [512, 896]  # æé«˜åˆ†è¾¨çŽ‡
```

---

## ðŸŽ“ æŠ€æœ¯äº®ç‚¹

1. **ç«¯åˆ°ç«¯å­¦ä¹ **: ä»Žåƒç´ åˆ°åƒç´ çš„ç›´æŽ¥æ˜ å°„
2. **æ‰©æ•£æ¨¡åž‹**: é«˜è´¨é‡å›¾åƒç”Ÿæˆèƒ½åŠ›
3. **æ—¶åºå»ºæ¨¡**: 3Då·ç§¯+æ³¨æ„åŠ›æœºåˆ¶æ•æ‰è¿åŠ¨
4. **åˆ†å¸ƒå¼è®­ç»ƒ**: é«˜æ•ˆçš„å¤šGPUè®­ç»ƒ
5. **å³æ’å³ç”¨**: å®Œæ•´çš„è®­ç»ƒè¯„ä¼°æµç¨‹

---

## ðŸ“ æ–‡ä»¶ç´¢å¼•

### å¿«é€ŸæŸ¥æ‰¾

**æˆ‘æƒ³...**

- **å¼€å§‹è®­ç»ƒ** â†’ `QUICK_START_GUIDE.md`
- **äº†è§£è¯¦ç»†** â†’ `VIDEO_PREDICTION_README.md`
- **æŸ¥çœ‹æ–‡ä»¶** â†’ `VIDEO_PREDICTION_FILES.md`
- **æµ‹è¯•çŽ¯å¢ƒ** â†’ `python test_video_prediction.py`
- **å‡†å¤‡æ•°æ®** â†’ `python prepare_video_data.py --help`
- **ä¿®æ”¹é…ç½®** â†’ `configs/config_video_prediction.yaml`

### æ ¸å¿ƒä»£ç ä½ç½®

**æˆ‘è¦ä¿®æ”¹...**

- **æ•°æ®åŠ è½½** â†’ `dataset/video_prediction_dataset.py`
- **æ¨¡åž‹ç»“æž„** â†’ `model/video_prediction_diffusion.py`
- **è®­ç»ƒé€»è¾‘** â†’ `video_prediction_trainer.py`
- **æŸå¤±å‡½æ•°** â†’ `model/video_prediction_diffusion.py::forward()`
- **é‡‡æ ·æ–¹æ³•** â†’ `model/video_prediction_diffusion.py::sample()`

---

## ðŸŽ¯ é¡¹ç›®ç‰¹è‰²

### âœ… å®Œæ•´æ€§
- ä»Žæ•°æ®å‡†å¤‡åˆ°æ¨¡åž‹éƒ¨ç½²çš„å…¨æµç¨‹
- è®­ç»ƒã€è¯„ä¼°ã€æŽ¨ç†ä¸‰ä½ä¸€ä½“
- è¯¦å°½çš„æ–‡æ¡£å’Œç¤ºä¾‹

### âœ… æ˜“ç”¨æ€§
- ä¸€é”®å¯åŠ¨è„šæœ¬
- æ¸…æ™°çš„é…ç½®æ–‡ä»¶
- å‹å¥½çš„é”™è¯¯æç¤º
- å®Œå–„çš„æµ‹è¯•å·¥å…·

### âœ… å¯æ‰©å±•æ€§
- æ¨¡å—åŒ–è®¾è®¡
- çµæ´»çš„é…ç½®ç³»ç»Ÿ
- æ˜“äºŽä¿®æ”¹å’Œä¼˜åŒ–

### âœ… å·¥ç¨‹åŒ–
- åˆ†å¸ƒå¼è®­ç»ƒæ”¯æŒ
- æ··åˆç²¾åº¦å…¼å®¹
- æ£€æŸ¥ç‚¹ç®¡ç†
- æ—¥å¿—å’Œå¯è§†åŒ–

---

## ðŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥ï¼‰

```bash
# 1ï¸âƒ£ æµ‹è¯•çŽ¯å¢ƒ
python test_video_prediction.py

# 2ï¸âƒ£ å‡†å¤‡æ•°æ®ï¼ˆå¦‚éœ€è¦ï¼‰
python prepare_video_data.py --data_root /your/data --output_dir data/infos

# 3ï¸âƒ£ å¼€å§‹è®­ç»ƒ
torchrun --nproc_per_node=4 train_video_pred.py --config configs/config_video_prediction.yaml
```

**å°±è¿™ä¹ˆç®€å•ï¼** ðŸŽ‰

---

## ðŸ“ž æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼ŸæŒ‰é¡ºåºå°è¯•ï¼š

1. âœ… è¿è¡Œ `python test_video_prediction.py`
2. ðŸ“– æŸ¥çœ‹ `VIDEO_PREDICTION_README.md` å¸¸è§é—®é¢˜éƒ¨åˆ†
3. ðŸ” æ£€æŸ¥ TensorBoard æ—¥å¿—
4. ðŸ› æ£€æŸ¥æ•°æ®è·¯å¾„å’Œé…ç½®æ–‡ä»¶

---

## ðŸ“„ è®¸å¯å’Œè‡´è°¢

- åŸºäºŽ DiffAD é¡¹ç›®æ‰©å±•
- ä½¿ç”¨ Stable Diffusion VAE
- é‡‡ç”¨ DiT æž¶æž„
- æ”¯æŒ Bench2Drive æ•°æ®é›†

---

**é¡¹ç›®åˆ›å»ºæ—¶é—´**: 2024å¹´11æœˆ
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… å®Œæˆå¹¶å¯ç”¨

---

**ç¥æ‚¨è®­ç»ƒæ„‰å¿«ï¼** ðŸš€ðŸŽ¬

